# Configuration Examples

Curated configs that match the current scoring stack (Markov ensemble + calibration + OOD). Use them as starting points when uploading configs to KV.

| File | Use Case | Highlights |
|------|----------|------------|
| `config.json` | Balanced default | Mirrors `DEFAULT_CONFIG`, no overrides, calibration field set to `null` placeholder |
| `config-strict.json` | Aggressive fraud blocking | Lower thresholds, higher OOD ceiling, stronger ensemble boost |
| `config-lenient.json` | Minimize false positives | High block threshold, lighter OOD risk, keeps Markov online but keeps `actionOverride: "allow"` |
| `config-pattern-only.json` | Pattern-telemetry focus | Disposable + TLD disabled, thresholds tuned so sequential/dated dominate |

All configs now ship with:

- `adjustments.professionalAbnormalityFactor` so corporate senders reduce OOD contributions.
- `ensemble` + `ood` sections that match the middleware implementation.
- `calibration: null` placeholder. Replace this with the JSON generated by the calibration trainer (see below).

## Updating KV with a Calibrated Config

1. Train + upload the calibration layer (writes the coefficients and merges them into `config.json` in KV):

```bash
npm run cli train:calibrate -- \
  --dataset dataset/training_compiled/training_compiled.csv \
  --models models \
  --output calibration.json \
  --upload --remote
```

2. To upload one of the example configs without calibration baked in, copy it and set `calibration` to the JSON generated in step 1, then push via wrangler:

```bash
cp examples/config.json /tmp/config.json
# replace the "calibration": null block with the coefficients you trained
npx wrangler kv key put config.json \
  --path=/tmp/config.json \
  --binding=CONFIG \
  --remote
```

## Key Fields (v2.5)

- `riskThresholds.block/warn` – master guardrails (0–1 risk).
- `confidenceThresholds` – Markov & pattern confidence gates.
- `riskWeights.domainReputation/tldRisk` – only remaining additive weights.
- `patternThresholds` – sequential/dates/plus thresholds that feed deterministic overrides.
- `adjustments` – professional senders receive reductions on classification/domain/OOD risk.
- `ensemble` – governs the blend between Markov classification and TLD signals.
- `ood` – caps and ramps abnormality risk based on min-entropy.
- `calibration` – optional logistic regression coefficients. Keep it `null` for “no calibration”.

## Testing

After uploading a config, validate behaviour before production rollout:

```bash
# Single e-mail probe
curl -X POST https://<worker>/validate \
  -H "Content-Type: application/json" \
  -d '{"email":"user123@gmail.com"}'

# Batch evaluation
npm run cli test:batch -- \
  --input dataset/pattern_labeled_emails.csv \
  --endpoint https://<worker>/validate
```
