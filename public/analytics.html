<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Analytics</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="/js/chart.umd.js"></script>
    <script src="/js/hammer.min.js"></script>
    <script src="/js/chartjs-plugin-zoom.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border: #e0e0e0;
            --accent: #667eea;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            /* Lovelace theme - dark with good contrast */
            --bg-primary: #1c1c1c;
            --bg-card: #2b2b2b;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --border: #404040;
            --accent: #bb86fc;
            --success: #4caf50;
            --warning: #ffb74d;
            --danger: #ef5350;
            --shadow: 0 2px 12px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .header {
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        h1 { color: var(--accent); font-size: 28px; }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar input, .toolbar select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); }
        .theme-toggle {
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .tab:hover { background: var(--bg-primary); }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .panel {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .panel.fullscreen {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            z-index: 1000;
            margin: 0;
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        .panel-actions button {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .panel-actions button:hover,
        .panel-actions button:focus {
            background: var(--bg-primary);
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn:focus, .tab:focus, .theme-toggle:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .panel-body {
            padding: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .panel.fullscreen .chart-container {
            height: calc(100vh - 150px);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-primary);
        }

        table th {
            background: var(--bg-primary);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: black; }
        .badge-danger { background: var(--danger); color: white; }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            z-index: 2000;
            min-width: 300px;
            max-width: 500px;
            animation: slideIn 0.3s ease-out;
            color: var(--text-primary);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error { border-left: 4px solid var(--danger); }
        .notification.success { border-left: 4px solid var(--success); }
        .notification.warning { border-left: 4px solid var(--warning); }

        .notification-close {
            float: right;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .notification-close:hover {
            color: var(--text-primary);
        }

        .info-box {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
        }

        .query-result {
            max-height: 500px;
            overflow: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üìä Fraud Detection Analytics</h1>
            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">Real-time email validation insights</div>
        </div>
        <div class="toolbar">
            <input type="password" id="apiKey" placeholder="Admin API Key" style="width: 200px;" aria-label="Admin API Key">
            <select id="timeRange" aria-label="Time range selector">
                <option value="1">Last 1 hour</option>
                <option value="6">Last 6 hours</option>
                <option value="24" selected>Last 24 hours</option>
                <option value="72">Last 3 days</option>
                <option value="168">Last 7 days</option>
            </select>
            <button class="btn" onclick="loadAll()" aria-label="Refresh dashboard data">üîÑ Refresh</button>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark/light theme">üåì</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab(0)">Dashboard</button>
        <button class="tab" onclick="switchTab(1)">Query Builder</button>
        <button class="tab" onclick="switchTab(2)">Data Explorer</button>
        <button class="tab" onclick="switchTab(3)">Data Management</button>
    </div>

    <!-- Dashboard Tab (Consolidated Overview, Detection, Performance) -->
    <div class="tab-content active" id="tab-dashboard">
        <div class="stat-grid" id="stats"></div>

        <div class="grid">
            <!-- Decision Breakdown -->
            <div class="panel" id="panel-decisions">
                <div class="panel-header">
                    <div class="panel-title">Decision Breakdown</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('decisions')" title="Refresh" aria-label="Refresh decision breakdown chart">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-decisions')" title="Fullscreen" aria-label="Toggle fullscreen for decision breakdown">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-decisions"></canvas>
                    </div>
                </div>
            </div>

            <!-- Risk Distribution -->
            <div class="panel" id="panel-risk">
                <div class="panel-header">
                    <div class="panel-title">Risk Score Distribution</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('risk')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-risk')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-risk"></canvas>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="panel grid-full" id="panel-timeline">
                <div class="panel-header">
                    <div class="panel-title">Validations Timeline</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('timeline')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-timeline')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-timeline"></canvas>
                    </div>
                </div>
            </div>

            <!-- Country Breakdown -->
            <div class="panel" id="panel-countries">
                <div class="panel-header">
                    <div class="panel-title">Top Countries</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('countries')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-countries')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-countries"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pattern Types -->
            <div class="panel" id="panel-patterns">
                <div class="panel-header">
                    <div class="panel-title">Pattern Types Detected</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('patterns')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-patterns')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-patterns"></canvas>
                    </div>
                </div>
            </div>

            <!-- Block Reasons -->
            <div class="panel" id="panel-blocks">
                <div class="panel-header">
                    <div class="panel-title">Top Block Reasons</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('blocks')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-blocks')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-blocks"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Domains -->
            <div class="panel" id="panel-domains">
                <div class="panel-header">
                    <div class="panel-title">Top Email Domains</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('domains')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-domains')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-domains"></canvas>
                    </div>
                </div>
            </div>

            <!-- TLD Analysis -->
            <div class="panel" id="panel-tld">
                <div class="panel-header">
                    <div class="panel-title">Top-Level Domains (TLD)</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('tld')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-tld')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-tld"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pattern Families -->
            <div class="panel" id="panel-pattern-families">
                <div class="panel-header">
                    <div class="panel-title">Pattern Families</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('pattern-families')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-pattern-families')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-pattern-families"></canvas>
                    </div>
                </div>
            </div>

            <!-- Disposable Domains -->
            <div class="panel" id="panel-disposable">
                <div class="panel-header">
                    <div class="panel-title">Disposable vs Normal Domains</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('disposable')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-disposable')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-disposable"></canvas>
                    </div>
                </div>
            </div>

            <!-- Free Providers -->
            <div class="panel" id="panel-free">
                <div class="panel-header">
                    <div class="panel-title">Free vs Paid Email Providers</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('free')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-free')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-free"></canvas>
                    </div>
                </div>
            </div>

            <!-- Plus Addressing -->
            <div class="panel" id="panel-plus">
                <div class="panel-header">
                    <div class="panel-title">Plus Addressing Usage</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('plus')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-plus')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-plus"></canvas>
                    </div>
                </div>
            </div>

            <!-- Keyboard Walk Detection -->
            <div class="panel" id="panel-keyboard">
                <div class="panel-header">
                    <div class="panel-title">Keyboard Walk Patterns</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('keyboard')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-keyboard')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-keyboard"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gibberish Detection -->
            <div class="panel" id="panel-gibberish">
                <div class="panel-header">
                    <div class="panel-title">Gibberish Detection</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('gibberish')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-gibberish')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-gibberish"></canvas>
                    </div>
                </div>
            </div>

            <!-- Entropy Distribution -->
            <div class="panel" id="panel-entropy">
                <div class="panel-header">
                    <div class="panel-title">Entropy Score Distribution</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('entropy')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-entropy')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-entropy"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bot Score Distribution -->
            <div class="panel" id="panel-bot">
                <div class="panel-header">
                    <div class="panel-title">Bot Score Distribution</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('bot')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-bot')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-bot"></canvas>
                    </div>
                </div>
            </div>

            <!-- Latency -->
            <div class="panel" id="panel-latency">
                <div class="panel-header">
                    <div class="panel-title">Validation Latency</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('latency')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-latency')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-latency"></canvas>
                    </div>
                </div>
            </div>

            <!-- ASN Analysis -->
            <div class="panel" id="panel-asn">
                <div class="panel-header">
                    <div class="panel-title">Top ASNs (Autonomous Systems)</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('asn')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-asn')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-asn"></canvas>
                    </div>
                </div>
            </div>

            <!-- TLD Risk Scores -->
            <div class="panel" id="panel-tld-risk">
                <div class="panel-header">
                    <div class="panel-title">TLD Risk Scores</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('tld-risk')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-tld-risk')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-tld-risk"></canvas>
                    </div>
                </div>
            </div>

            <!-- Domain Reputation -->
            <div class="panel" id="panel-domain-reputation">
                <div class="panel-header">
                    <div class="panel-title">Domain Reputation Scores</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('domain-reputation')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-domain-reputation')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-domain-reputation"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pattern Confidence -->
            <div class="panel" id="panel-pattern-confidence">
                <div class="panel-header">
                    <div class="panel-title">Pattern Confidence Scores</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('pattern-confidence')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-pattern-confidence')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-container">
                        <canvas id="chart-pattern-confidence"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent High-Risk Events -->
            <div class="panel grid-full" id="panel-events">
                <div class="panel-header">
                    <div class="panel-title">Recent High-Risk Events (Risk Score > 0.6)</div>
                    <div class="panel-actions">
                        <button onclick="refreshPanel('events')" title="Refresh">üîÑ</button>
                        <button onclick="toggleFullscreen('panel-events')" title="Fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="events-table"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Builder Tab -->
    <div class="tab-content" id="tab-query">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Custom SQL Query</div>
            </div>
            <div class="panel-body">
                <div class="info-box">
                    <strong>üí° Tips:</strong> Write SQL queries against the ANALYTICS table. Available time range is selected at the top.
                    <a href="#" onclick="showColumnMapping(); return false;" style="color: var(--accent); margin-left: 10px;">View Column Mapping</a>
                </div>
                <textarea id="custom-sql" rows="10">SELECT
  blob1 as decision,
  blob7 as pattern_type,
  blob5 as domain,
  double1 as risk_score,
  double2 as entropy_score,
  double3 as bot_score,
  timestamp
FROM ANALYTICS
WHERE timestamp >= NOW() - INTERVAL '24' HOUR
  AND double1 > 0.5
ORDER BY timestamp DESC
LIMIT 100</textarea>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="runCustomSQL()">‚ñ∂ Run Query</button>
                    <button class="btn btn-secondary" onclick="showExampleQueries()">üìù Example Queries</button>
                    <button class="btn btn-secondary" onclick="exportToCSV(lastQueryResult, 'query-result.csv')">üì• Export CSV</button>
                    <button class="btn btn-secondary" onclick="exportToJSON(lastQueryResult, 'query-result.json')">üì• Export JSON</button>
                </div>
                <div id="query-result" class="query-result"></div>
            </div>
        </div>
    </div>

    <!-- Data Explorer Tab -->
    <div class="tab-content" id="tab-explorer">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Data Explorer</div>
            </div>
            <div class="panel-body">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="explorer-view">
                        <option value="recent">Recent Validations</option>
                        <option value="high-risk">High Risk (>0.6)</option>
                        <option value="blocked">Blocked Emails</option>
                        <option value="patterns">Pattern Detections</option>
                        <option value="disposable">Disposable Domains</option>
                        <option value="comprehensive">Comprehensive View (All Columns)</option>
                    </select>
                    <select id="explorer-time">
                        <option value="15">Last 15 minutes</option>
                        <option value="60" selected>Last 1 hour</option>
                        <option value="360">Last 6 hours</option>
                        <option value="1440">Last 24 hours</option>
                    </select>
                    <select id="explorer-limit">
                        <option value="50">50 rows</option>
                        <option value="100" selected>100 rows</option>
                        <option value="500">500 rows</option>
                        <option value="1000">1000 rows</option>
                    </select>
                    <button class="btn" onclick="loadExplorer()">üîç Explore</button>
                    <button class="btn btn-secondary" onclick="exportToCSV(lastExplorerResult, 'explorer-result.csv')">üì• Export CSV</button>
                    <button class="btn btn-secondary" onclick="exportToJSON(lastExplorerResult, 'explorer-result.json')">üì• Export JSON</button>
                </div>
                <div id="explorer-result" class="query-result"></div>
            </div>
        </div>
    </div>

    <!-- Data Management Tab -->
    <div class="tab-content" id="tab-management">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Analytics Engine Data Management</div>
            </div>
            <div class="panel-body">
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Important:</strong> Cloudflare Analytics Engine data is immutable and cannot be deleted directly.
                    Data is automatically retained for 6 months. Use the tools below to generate SQL filters to exclude unwanted data from queries.
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter by Time Range</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Generate a SQL filter to exclude data older than a specified time.</p>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <input type="number" id="truncate-hours" value="24" min="1" style="width: 100px;" placeholder="Hours">
                    <button class="btn" onclick="generateTimeFilter()">Generate Time Filter</button>
                </div>
                <div id="time-filter-result" style="margin-bottom: 30px;"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter Test Data</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Generate SQL filters to exclude common test data patterns.</p>
                <button class="btn" onclick="generateTestDataFilter()">Generate Test Data Filters</button>
                <div id="test-filter-result" style="margin-top: 15px;"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Dataset Information</h3>
                <button class="btn btn-secondary" onclick="loadDatasetInfo()">üìä View Dataset Info</button>
                <div id="dataset-info" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentTab = 0;
        let loadingPanels = new Set();

        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-close" onclick="this.parentElement.remove()">√ó</span>
                <div>${message}</div>
            `;
            document.body.appendChild(notification);

            if (duration > 0) {
                setTimeout(() => {
                    notification.remove();
                }, duration);
            }

            return notification;
        }

        // Loading indicator system
        function showLoading(panelId) {
            loadingPanels.add(panelId);
            const panelBody = document.querySelector(`#panel-${panelId} .panel-body, #${panelId}-table, #${panelId}-result, #${panelId}`);
            if (panelBody && !panelBody.querySelector('.spinner')) {
                const spinner = document.createElement('div');
                spinner.className = 'loading';
                spinner.innerHTML = '<div class="spinner"></div><div>Loading data...</div>';
                spinner.setAttribute('data-spinner', 'true');
                panelBody.innerHTML = '';
                panelBody.appendChild(spinner);
            }
        }

        function hideLoading(panelId) {
            loadingPanels.delete(panelId);
            const spinner = document.querySelector(`#panel-${panelId} [data-spinner="true"], #${panelId}-table [data-spinner="true"], #${panelId}-result [data-spinner="true"], #${panelId} [data-spinner="true"]`);
            if (spinner) {
                spinner.remove();
            }
        }

        // API helper with loading states and error handling
        async function apiCall(endpoint, options = {}) {
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                showNotification('Please enter your Admin API Key', 'warning');
                throw new Error('API key required');
            }

            try {
                const response = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Unknown error' }));
                    throw new Error(error.message || `HTTP ${response.status}`);
                }

                return response.json();
            } catch (error) {
                showNotification(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Query helper
        async function query(sql) {
            const hours = document.getElementById('timeRange').value;
            const encodedSQL = encodeURIComponent(sql);
            return apiCall(`/admin/analytics?query=${encodedSQL}&hours=${hours}`);
        }

        // Data export helpers
        function exportToCSV(data, filename = 'export.csv') {
            if (!data || data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            const columns = Object.keys(data[0]);
            const csv = [
                columns.join(','),
                ...data.map(row => columns.map(col => {
                    const value = row[col];
                    if (value === null || value === undefined) return '';
                    const stringValue = String(value);
                    // Escape quotes and wrap in quotes if contains comma, quote, or newline
                    if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    return stringValue;
                }).join(','))
            ].join('\n');

            downloadFile(csv, filename, 'text/csv');
            showNotification(`Exported ${data.length} rows to ${filename}`, 'success');
        }

        function exportToJSON(data, filename = 'export.json') {
            if (!data || data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            const json = JSON.stringify(data, null, 2);
            downloadFile(json, filename, 'application/json');
            showNotification(`Exported ${data.length} rows to ${filename}`, 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Store last query result for export
        let lastQueryResult = null;
        let lastExplorerResult = null;

        // Theme toggle
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'dark' ? '' : 'dark');
        }

        // Tab switching
        function switchTab(index) {
            currentTab = index;
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Fullscreen toggle
        function toggleFullscreen(panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.toggle('fullscreen');

            // Resize chart when entering/exiting fullscreen
            const canvas = panel.querySelector('canvas');
            if (canvas) {
                const chartId = canvas.id.replace('chart-', '');
                if (charts[chartId]) {
                    setTimeout(() => charts[chartId].resize(), 100);
                }
            }
        }

        // Chart creation helper
        function createChart(id, config) {
            const canvas = document.getElementById(`chart-${id}`);
            if (!canvas) return;

            // Destroy existing chart
            if (charts[id]) {
                charts[id].destroy();
            }

            const ctx = canvas.getContext('2d');

            // Add scale configuration to prevent negative numbers for bar and line charts
            const scalesConfig = config.type === 'bar' || config.type === 'line' ? {
                y: {
                    beginAtZero: true,
                    min: 0,
                    ticks: {
                        callback: function(value) {
                            // Ensure only non-negative integers are displayed
                            return value < 0 ? '' : Math.round(value);
                        }
                    }
                }
            } : {};

            charts[id] = new Chart(ctx, {
                ...config,
                options: {
                    ...config.options,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        ...scalesConfig,
                        ...config.options?.scales,
                    },
                    plugins: {
                        ...config.options?.plugins,
                        zoom: {
                            limits: {
                                y: { min: 0, max: 'original' },
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true,
                                },
                                mode: 'xy',
                            },
                        },
                    },
                },
            });
        }

        // Load stats cards
        async function loadStats() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob1 as decision,
                    SUM(_sample_interval) as count,
                    SUM(_sample_interval * double1) / SUM(_sample_interval) as avg_risk,
                    SUM(_sample_interval * double5) / SUM(_sample_interval) as avg_latency
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY decision
            `);

            let total = 0, blocked = 0, warned = 0, allowed = 0;
            let totalRisk = 0, totalLatency = 0, riskCount = 0;

            data.data.forEach(row => {
                const count = parseInt(row.count, 10) || 0;
                total += count;
                if (row.decision === 'block') blocked += count;
                else if (row.decision === 'warn') warned += count;
                else if (row.decision === 'allow') allowed += count;
                totalRisk += parseFloat(row.avg_risk || 0) * count;
                totalLatency += parseFloat(row.avg_latency || 0) * count;
                riskCount += count;
            });

            const avgRisk = riskCount > 0 ? (totalRisk / riskCount).toFixed(3) : '0.000';
            const avgLatency = total > 0 ? (totalLatency / total).toFixed(1) : '0.0';

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total.toLocaleString()}</div>
                    <div class="stat-label">Total Validations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--danger)">${blocked.toLocaleString()}</div>
                    <div class="stat-label">Blocked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--warning)">${warned.toLocaleString()}</div>
                    <div class="stat-label">Warned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success)">${allowed.toLocaleString()}</div>
                    <div class="stat-label">Allowed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgRisk}</div>
                    <div class="stat-label">Avg Risk Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgLatency}ms</div>
                    <div class="stat-label">Avg Latency</div>
                </div>
            `;
        }

        // Load decisions chart
        async function loadDecisions() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob1 as decision,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY decision
                ORDER BY count DESC
            `);

            const colorMap = {
                'allow': '#28a745',
                'warn': '#ffc107',
                'block': '#dc3545'
            };

            createChart('decisions', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.decision),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: data.data.map(r => colorMap[r.decision] || '#667eea'),
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load risk distribution
        async function loadRisk() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob4 as risk_bucket,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY risk_bucket
                ORDER BY risk_bucket
            `);

            createChart('risk', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.risk_bucket),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load timeline
        async function loadTimeline() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    toStartOfHour(timestamp) as hour,
                    blob1 as decision,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY hour, decision
                ORDER BY hour ASC
            `);

            // Group by decision
            const grouped = {};
            data.data.forEach(row => {
                if (!grouped[row.decision]) {
                    grouped[row.decision] = {};
                }
                grouped[row.decision][row.hour] = parseInt(row.count, 10) || 0;
            });

            // Get all unique hours
            const hours_set = [...new Set(data.data.map(r => r.hour))].sort();

            const colorMap = {
                'allow': '#28a745',
                'warn': '#ffc107',
                'block': '#dc3545'
            };

            const datasets = Object.entries(grouped).map(([decision, hourData]) => ({
                label: decision,
                data: hours_set.map(h => hourData[h] || 0),
                borderColor: colorMap[decision] || '#667eea',
                backgroundColor: colorMap[decision] || '#667eea',
                tension: 0.4,
            }));

            createChart('timeline', {
                type: 'line',
                data: {
                    labels: hours_set.map(h => new Date(h).toLocaleString()),
                    datasets,
                },
                options: {
                    plugins: {
                        legend: { position: 'top' },
                    },
                },
            });
        }

        // Load countries
        async function loadCountries() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob3 as country,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY country
                ORDER BY count DESC
                LIMIT 15
            `);

            createChart('countries', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.country),
                    datasets: [{
                        label: 'Validations',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load patterns
        async function loadPatterns() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob7 as pattern_type,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND blob7 != 'none'
                GROUP BY pattern_type
                ORDER BY count DESC
                LIMIT 10
            `);

            createChart('patterns', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.pattern_type),
                    datasets: [{
                        label: 'Detections',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#dc3545',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load blocks
        async function loadBlocks() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob2 as block_reason,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND blob1 = 'block'
                  AND blob2 != 'none'
                GROUP BY block_reason
                ORDER BY count DESC
                LIMIT 10
            `);

            createChart('blocks', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.block_reason),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#dc3545',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load domains
        async function loadDomains() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob5 as domain,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY domain
                ORDER BY count DESC
                LIMIT 15
            `);

            createChart('domains', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.domain),
                    datasets: [{
                        label: 'Validations',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load TLD
        async function loadTLD() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob6 as tld,
                    SUM(_sample_interval) as count,
                    SUM(_sample_interval * double6) / SUM(_sample_interval) as avg_tld_risk
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY tld
                ORDER BY count DESC
                LIMIT 15
            `);

            createChart('tld', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.tld),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load pattern families
        async function loadPatternFamilies() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob8 as pattern_family,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND blob8 != 'none'
                GROUP BY pattern_family
                ORDER BY count DESC
                LIMIT 10
            `);

            createChart('pattern-families', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.pattern_family),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: [
                            '#667eea', '#dc3545', '#28a745', '#ffc107',
                            '#17a2b8', '#6c757d', '#e83e8c', '#fd7e14'
                        ],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load disposable
        async function loadDisposable() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob9 as is_disposable,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY is_disposable
            `);

            createChart('disposable', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.is_disposable),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: ['#28a745', '#dc3545'],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load free providers
        async function loadFree() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob10 as is_free,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY is_free
            `);

            createChart('free', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.is_free),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: ['#28a745', '#ffc107'],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load plus addressing
        async function loadPlus() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob11 as has_plus,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY has_plus
            `);

            createChart('plus', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.has_plus === 'yes' ? 'With Plus (+)' : 'Normal'),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: ['#ffc107', '#28a745'],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load keyboard walk
        async function loadKeyboard() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob12 as has_keyboard_walk,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY has_keyboard_walk
            `);

            createChart('keyboard', {
                type: 'doughnut',
                data: {
                    labels: data.data.map(r => r.has_keyboard_walk === 'yes' ? 'Keyboard Walk' : 'Normal'),
                    datasets: [{
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: ['#dc3545', '#28a745'],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load gibberish
        async function loadGibberish() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob13 as is_gibberish,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY is_gibberish
                ORDER BY is_gibberish DESC
            `);

            // Map data to ensure consistent ordering (Gibberish first, Normal second)
            const gibberishCount = data.data.find(r => r.is_gibberish === 'yes')?.count || 0;
            const normalCount = data.data.find(r => r.is_gibberish !== 'yes')?.count || 0;

            createChart('gibberish', {
                type: 'doughnut',
                data: {
                    labels: ['Gibberish', 'Normal'],
                    datasets: [{
                        data: [parseInt(gibberishCount, 10) || 0, parseInt(normalCount, 10) || 0],
                        backgroundColor: ['#dc3545', '#28a745'],
                    }],
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                    },
                },
            });
        }

        // Load entropy
        async function loadEntropy() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    floor(double2 / 0.2) * 0.2 as entropy_bucket,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY entropy_bucket
                ORDER BY entropy_bucket
            `);

            createChart('entropy', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => `${parseFloat(r.entropy_bucket).toFixed(1)}-${(parseFloat(r.entropy_bucket) + 0.2).toFixed(1)}`),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load bot scores
        async function loadBot() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    floor(double3 / 20) * 20 as score_bucket,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY score_bucket
                ORDER BY score_bucket
            `);

            const labels = data.data.map(r => {
                const bucket = r.score_bucket;
                if (bucket >= 80) return 'Human (80-100)';
                if (bucket >= 60) return 'Likely Human (60-80)';
                if (bucket >= 40) return 'Uncertain (40-60)';
                if (bucket >= 20) return 'Likely Bot (20-40)';
                return 'Bot (0-20)';
            });

            createChart('bot', {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load latency
        async function loadLatency() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob1 as decision,
                    SUM(_sample_interval * double5) / SUM(_sample_interval) as avg_latency
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                GROUP BY decision
            `);

            createChart('latency', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.decision),
                    datasets: [{
                        label: 'Avg Latency (ms)',
                        data: data.data.map(r => parseFloat(r.avg_latency) || 0),
                        backgroundColor: '#28a745',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load ASN
        async function loadASN() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    double4 as asn,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND double4 > 0
                GROUP BY asn
                ORDER BY count DESC
                LIMIT 15
            `);

            createChart('asn', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => `AS${r.asn}`),
                    datasets: [{
                        label: 'Validations',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load TLD risk scores
        async function loadTLDRisk() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob6 as tld,
                    SUM(_sample_interval * double6) / SUM(_sample_interval) as avg_risk
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND double6 > 0
                GROUP BY tld
                ORDER BY avg_risk DESC
                LIMIT 15
            `);

            createChart('tld-risk', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => r.tld),
                    datasets: [{
                        label: 'Avg TLD Risk Score',
                        data: data.data.map(r => parseFloat(r.avg_risk) || 0),
                        backgroundColor: '#dc3545',
                    }],
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load domain reputation
        async function loadDomainReputation() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    floor(double7 / 0.2) * 0.2 as reputation_bucket,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND double7 > 0
                GROUP BY reputation_bucket
                ORDER BY reputation_bucket
            `);

            createChart('domain-reputation', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => `${parseFloat(r.reputation_bucket).toFixed(1)}-${(parseFloat(r.reputation_bucket) + 0.2).toFixed(1)}`),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#28a745',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load pattern confidence
        async function loadPatternConfidence() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    floor(double8 / 0.2) * 0.2 as confidence_bucket,
                    SUM(_sample_interval) as count
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND double8 > 0
                GROUP BY confidence_bucket
                ORDER BY confidence_bucket
            `);

            createChart('pattern-confidence', {
                type: 'bar',
                data: {
                    labels: data.data.map(r => `${parseFloat(r.confidence_bucket).toFixed(1)}-${(parseFloat(r.confidence_bucket) + 0.2).toFixed(1)}`),
                    datasets: [{
                        label: 'Count',
                        data: data.data.map(r => parseInt(r.count, 10) || 0),
                        backgroundColor: '#667eea',
                    }],
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // Load events table
        async function loadEvents() {
            const hours = document.getElementById('timeRange').value;
            const data = await query(`
                SELECT
                    blob14 as email,
                    blob5 as domain,
                    blob1 as decision,
                    blob2 as block_reason,
                    blob7 as pattern_type,
                    blob3 as country,
                    double1 as risk_score,
                    double2 as entropy_score,
                    double3 as bot_score,
                    timestamp
                FROM ANALYTICS
                WHERE timestamp >= NOW() - INTERVAL '${hours}' HOUR
                  AND double1 > 0.6
                ORDER BY timestamp DESC
                LIMIT 50
            `);

            const badgeClass = (decision) => {
                if (decision === 'block') return 'badge-danger';
                if (decision === 'warn') return 'badge-warning';
                return 'badge-success';
            };

            const html = data.data.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Domain</th>
                            <th>Decision</th>
                            <th>Block Reason</th>
                            <th>Pattern</th>
                            <th>Country</th>
                            <th>Risk Score</th>
                            <th>Entropy</th>
                            <th>Bot Score</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(row => `
                            <tr>
                                <td>${row.email || 'N/A'}</td>
                                <td>${row.domain || 'N/A'}</td>
                                <td><span class="badge ${badgeClass(row.decision)}">${row.decision}</span></td>
                                <td>${row.block_reason || '-'}</td>
                                <td>${row.pattern_type || 'none'}</td>
                                <td>${row.country || 'N/A'}</td>
                                <td>${parseFloat(row.risk_score || 0).toFixed(3)}</td>
                                <td>${parseFloat(row.entropy_score || 0).toFixed(3)}</td>
                                <td>${parseFloat(row.bot_score || 0).toFixed(0)}</td>
                                <td>${new Date(row.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<div class="loading">No high-risk events found</div>';

            document.getElementById('events-table').innerHTML = html;
        }

        // Refresh individual panel
        async function refreshPanel(panel) {
            showLoading(panel);
            try {
                switch(panel) {
                    case 'decisions': await loadDecisions(); break;
                    case 'risk': await loadRisk(); break;
                    case 'timeline': await loadTimeline(); break;
                    case 'countries': await loadCountries(); break;
                    case 'patterns': await loadPatterns(); break;
                    case 'blocks': await loadBlocks(); break;
                    case 'domains': await loadDomains(); break;
                    case 'tld': await loadTLD(); break;
                    case 'pattern-families': await loadPatternFamilies(); break;
                    case 'disposable': await loadDisposable(); break;
                    case 'free': await loadFree(); break;
                    case 'plus': await loadPlus(); break;
                    case 'keyboard': await loadKeyboard(); break;
                    case 'gibberish': await loadGibberish(); break;
                    case 'entropy': await loadEntropy(); break;
                    case 'bot': await loadBot(); break;
                    case 'latency': await loadLatency(); break;
                    case 'asn': await loadASN(); break;
                    case 'tld-risk': await loadTLDRisk(); break;
                    case 'domain-reputation': await loadDomainReputation(); break;
                    case 'pattern-confidence': await loadPatternConfidence(); break;
                    case 'events': await loadEvents(); break;
                }
            } catch (error) {
                console.error(`Error refreshing panel ${panel}:`, error);
                showNotification(`Failed to refresh ${panel}: ${error.message}`, 'error');
            } finally {
                hideLoading(panel);
            }
        }

        // Load all dashboard data
        async function loadAll() {
            if (currentTab !== 0) return; // Only load if on dashboard tab

            const notification = showNotification('Loading dashboard data...', 'info', 0);

            try {
                await loadStats();
                await Promise.all([
                    loadDecisions(),
                    loadRisk(),
                    loadTimeline(),
                    loadCountries(),
                    loadPatterns(),
                    loadBlocks(),
                    loadDomains(),
                    loadTLD(),
                    loadPatternFamilies(),
                    loadDisposable(),
                    loadFree(),
                    loadPlus(),
                    loadKeyboard(),
                    loadGibberish(),
                    loadEntropy(),
                    loadBot(),
                    loadLatency(),
                    loadASN(),
                    loadTLDRisk(),
                    loadDomainReputation(),
                    loadPatternConfidence(),
                    loadEvents(),
                ]);
                notification.remove();
                showNotification('Dashboard loaded successfully', 'success', 3000);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                notification.remove();
                showNotification(`Failed to load dashboard: ${error.message}`, 'error');
            }
        }

        // Custom SQL query
        async function runCustomSQL() {
            const sql = document.getElementById('custom-sql').value.trim();
            if (!sql) {
                showNotification('Please enter a SQL query', 'warning');
                return;
            }

            // Basic SQL validation warning
            const dangerousPatterns = /DROP|DELETE|UPDATE|INSERT|ALTER|CREATE|TRUNCATE|EXEC|EXECUTE/i;
            if (dangerousPatterns.test(sql)) {
                showNotification('Warning: Potentially dangerous SQL keywords detected. Analytics Engine is read-only, but be cautious.', 'warning', 10000);
            }

            showLoading('query-result');
            try {
                const data = await query(sql);

                if (!data.data || data.data.length === 0) {
                    lastQueryResult = null;
                    hideLoading('query-result');
                    document.getElementById('query-result').innerHTML = '<div class="info-box">No results found</div>';
                    return;
                }

                // Store result for export
                lastQueryResult = data.data;

                const columns = Object.keys(data.data[0]);

                // Helper function to format cell values
                const formatCell = (column, value) => {
                    if (value === null || value === undefined) return 'N/A';
                    if (column === 'decision' || column === 'blob1') {
                        const badgeClass = value === 'block' ? 'badge-danger' : value === 'warn' ? 'badge-warning' : 'badge-success';
                        return `<span class="badge ${badgeClass}">${value}</span>`;
                    }
                    if (column === 'timestamp' || column.includes('time')) {
                        try {
                            return new Date(value).toLocaleString();
                        } catch (e) {
                            return value;
                        }
                    }
                    if (typeof value === 'number') {
                        return value.toLocaleString();
                    }
                    return value;
                };

                const html = `
                    <table>
                        <thead>
                            <tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.data.map(row => `
                                <tr>${columns.map(c => `<td>${formatCell(c, row[c])}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                hideLoading('query-result');
                document.getElementById('query-result').innerHTML = html;
                showNotification(`Query returned ${data.data.length} rows`, 'success', 3000);
            } catch (error) {
                hideLoading('query-result');
                document.getElementById('query-result').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        // Show column mapping
        function showColumnMapping() {
            const mapping = {
                blob1: 'decision (allow/warn/block)',
                blob2: 'block_reason',
                blob3: 'country',
                blob4: 'risk_bucket',
                blob5: 'domain',
                blob6: 'tld',
                blob7: 'pattern_type',
                blob8: 'pattern_family',
                blob9: 'is_disposable',
                blob10: 'is_free_provider',
                blob11: 'has_plus_addressing',
                blob12: 'has_keyboard_walk',
                blob13: 'is_gibberish',
                blob14: 'email_local_part',
                double1: 'risk_score',
                double2: 'entropy_score',
                double3: 'bot_score',
                double4: 'asn',
                double5: 'latency_ms',
                double6: 'tld_risk_score',
                double7: 'domain_reputation_score',
                double8: 'pattern_confidence',
                index1: 'fingerprint_hash',
            };

            const html = `
                <div class="info-box">
                    <h3 style="margin-bottom: 10px;">Column Mapping</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(mapping).map(([col, desc]) => `
                                <tr>
                                    <td><code>${col}</code></td>
                                    <td>${desc}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('query-result').innerHTML = html;
        }

        // Show example queries
        async function showExampleQueries() {
            try {
                const data = await apiCall('/admin/analytics/queries');

                const html = `
                    <div class="info-box">
                        <h3 style="margin-bottom: 15px;">Example Queries</h3>
                        ${Object.entries(data.queries).map(([key, query]) => `
                            <div style="margin-bottom: 20px;">
                                <h4>${query.name}</h4>
                                <p style="color: var(--text-secondary); margin: 5px 0 10px 0;">${query.description}</p>
                                <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${query.sql}</pre>
                                <button class="btn btn-secondary" onclick="document.getElementById('custom-sql').value = \`${query.sql.replace(/`/g, '\\`')}\`; document.getElementById('query-result').innerHTML = '';">Use This Query</button>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('query-result').innerHTML = html;
            } catch (error) {
                document.getElementById('query-result').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        // Data Explorer
        async function loadExplorer() {
            const view = document.getElementById('explorer-view').value;
            const timeMinutes = parseInt(document.getElementById('explorer-time').value);
            const limit = parseInt(document.getElementById('explorer-limit').value);

            showLoading('explorer-result');

            // Convert minutes to proper SQL interval
            let timeInterval = '';
            if (timeMinutes < 60) {
                timeInterval = `'${timeMinutes}' MINUTE`;
            } else if (timeMinutes < 1440) {
                const hours = Math.floor(timeMinutes / 60);
                timeInterval = `'${hours}' HOUR`;
            } else {
                const days = Math.floor(timeMinutes / 1440);
                timeInterval = `'${days}' DAY`;
            }

            let sql = '';
            switch (view) {
                case 'recent':
                    sql = `SELECT blob14 as email, blob5 as domain, blob6 as tld,
                           blob1 as decision, blob2 as block_reason,
                           blob7 as pattern_type, blob3 as country,
                           double1 as risk_score, double2 as entropy_score,
                           double3 as bot_score, timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                           ORDER BY timestamp DESC LIMIT ${limit}`;
                    break;
                case 'high-risk':
                    sql = `SELECT blob14 as email, blob5 as domain,
                           blob1 as decision, blob2 as block_reason,
                           blob7 as pattern_type, double1 as risk_score,
                           double2 as entropy_score, double3 as bot_score,
                           timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                             AND double1 > 0.6
                           ORDER BY double1 DESC LIMIT ${limit}`;
                    break;
                case 'blocked':
                    sql = `SELECT blob14 as email, blob5 as domain,
                           blob2 as block_reason, blob7 as pattern_type,
                           double1 as risk_score, timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                             AND blob1 = 'block'
                           ORDER BY timestamp DESC LIMIT ${limit}`;
                    break;
                case 'patterns':
                    sql = `SELECT blob14 as email, blob5 as domain,
                           blob7 as pattern_type, blob8 as pattern_family,
                           double8 as pattern_confidence, double1 as risk_score,
                           blob1 as decision, timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                             AND blob7 != 'none'
                           ORDER BY timestamp DESC LIMIT ${limit}`;
                    break;
                case 'disposable':
                    sql = `SELECT blob14 as email, blob5 as domain,
                           blob9 as is_disposable, double1 as risk_score,
                           blob1 as decision, timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                             AND blob9 = 'disposable'
                           ORDER BY timestamp DESC LIMIT ${limit}`;
                    break;
                case 'comprehensive':
                    sql = `SELECT
                           blob14 as email, blob5 as domain, blob6 as tld,
                           blob1 as decision, blob2 as block_reason,
                           blob3 as country, blob4 as risk_bucket,
                           blob7 as pattern_type, blob8 as pattern_family,
                           blob9 as is_disposable, blob10 as is_free_provider,
                           blob11 as has_plus_addressing, blob12 as has_keyboard_walk,
                           blob13 as is_gibberish,
                           double1 as risk_score, double2 as entropy_score,
                           double3 as bot_score, double4 as asn,
                           double5 as latency_ms, double6 as tld_risk_score,
                           double7 as domain_reputation_score,
                           double8 as pattern_confidence,
                           timestamp
                           FROM ANALYTICS
                           WHERE timestamp >= NOW() - INTERVAL ${timeInterval}
                           ORDER BY timestamp DESC LIMIT ${limit}`;
                    break;
            }

            try {
                const data = await query(sql);

                if (!data.data || data.data.length === 0) {
                    lastExplorerResult = null;
                    hideLoading('explorer-result');
                    document.getElementById('explorer-result').innerHTML = '<div class="info-box">No results found</div>';
                    return;
                }

                // Store result for export
                lastExplorerResult = data.data;

                const columns = Object.keys(data.data[0]);

                // Helper function to format cell values
                const formatValue = (column, value) => {
                    if (value === null || value === undefined) return 'N/A';
                    if (column === 'decision') {
                        const badgeClass = value === 'block' ? 'badge-danger' : value === 'warn' ? 'badge-warning' : 'badge-success';
                        return `<span class="badge ${badgeClass}">${value}</span>`;
                    }
                    if (column === 'timestamp') {
                        try {
                            return new Date(value).toLocaleString();
                        } catch (e) {
                            return value;
                        }
                    }
                    // Format numeric values (risk scores, entropy, etc.)
                    if (typeof value === 'number') {
                        if (column.includes('score') || column.includes('confidence') || column.includes('entropy')) {
                            return value.toFixed(3);
                        }
                        if (column === 'latency_ms') {
                            return value.toFixed(1) + 'ms';
                        }
                        return value.toLocaleString();
                    }
                    return value;
                };

                const html = `
                    <table>
                        <thead>
                            <tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.data.map(row => `
                                <tr>${columns.map(c => `<td>${formatValue(c, row[c])}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                hideLoading('explorer-result');
                document.getElementById('explorer-result').innerHTML = html;
                showNotification(`Loaded ${data.data.length} rows`, 'success', 3000);
            } catch (error) {
                hideLoading('explorer-result');
                document.getElementById('explorer-result').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        // Data Management
        async function generateTimeFilter() {
            const hours = document.getElementById('truncate-hours').value;

            try {
                const data = await apiCall('/admin/analytics/truncate', {
                    method: 'POST',
                    body: JSON.stringify({ olderThanHours: parseInt(hours) }),
                });

                document.getElementById('time-filter-result').innerHTML = `
                    <div class="info-box">
                        <p><strong>${data.message}</strong></p>
                        <p style="margin-top: 10px;"><strong>Filter Query:</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; overflow-x: auto;">${data.filterQuery}</pre>
                        <p style="margin-top: 10px;"><strong>Example Usage:</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; overflow-x: auto;">${data.example}</pre>
                        <p style="margin-top: 10px; font-style: italic; color: var(--text-secondary);">${data.note}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('time-filter-result').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        async function generateTestDataFilter() {
            try {
                const data = await apiCall('/admin/analytics/test-data', {
                    method: 'DELETE',
                });

                document.getElementById('test-filter-result').innerHTML = `
                    <div class="info-box">
                        <p><strong>${data.message}</strong></p>
                        <p style="margin-top: 10px;"><strong>Individual Filters:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${data.filters.map(f => `<li><code>${f}</code></li>`).join('')}
                        </ul>
                        <p style="margin-top: 10px;"><strong>Combined Filter:</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; overflow-x: auto;">${data.combinedFilter}</pre>
                        <p style="margin-top: 10px;"><strong>Example Usage:</strong></p>
                        <pre style="background: var(--bg-primary); padding: 10px; border-radius: 4px; overflow-x: auto;">${data.example}</pre>
                        <p style="margin-top: 10px; font-style: italic; color: var(--text-secondary);">${data.note}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('test-filter-result').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        async function loadDatasetInfo() {
            try {
                const data = await apiCall('/admin/analytics/info');

                document.getElementById('dataset-info').innerHTML = `
                    <div class="info-box">
                        <h3 style="margin-bottom: 15px;">Dataset: ${data.dataset}</h3>

                        <h4 style="margin-top: 20px;">Data Retention</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>${data.dataRetention.description}</li>
                            <li>${data.dataRetention.automaticDeletion}</li>
                            <li>${data.dataRetention.manualDeletion}</li>
                        </ul>

                        <h4 style="margin-top: 20px;">Data Management</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Filter by Time:</strong> ${data.dataManagement.filterByTime}</li>
                            <li><strong>Exclude Test Data:</strong> ${data.dataManagement.excludeTestData}</li>
                            <li><strong>Export Data:</strong> ${data.dataManagement.exportData}</li>
                        </ul>

                        <h4 style="margin-top: 20px;">Best Practices</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${data.bestPractices.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } catch (error) {
                document.getElementById('dataset-info').innerHTML = `<div class="info-box" style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            loadAll();
        });
    </script>
</body>
</html>
